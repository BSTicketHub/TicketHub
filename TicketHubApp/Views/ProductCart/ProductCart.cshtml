
@{
    ViewBag.Title = "Cart";
}

@Styles.Render("~/bundles/css/Cart")



<div class="container">
    <ol class="row cartProcess">
        <li class="breadcrumb-item"><a href="#">購物車與結帳</a></li>
        <a class="breadcrumb-item active" aria-current="page" href="#">訂購完成</a>
        <!-- 文字無法貼齊 -->
    </ol>
</div>
<div class="container bg-white">
    <div class="cartContent p-3">
        <div>
            <h2>購物車</h2>
        </div>
        <hr />
        <div class="new-table">
            <div class="table-header row text-center">
                <div class="col-1"></div>
                <div class="col-2">圖片</div>
                <div class="col-3">票券簡介</div>
                <div class="col-2">單價</div>
                <div class="col-1">張數</div>
                <div class="col-2">總價</div>
                <div class="col-1">刪除</div>
            </div>
            <div class="table-body text-center mt-3">
                <div class="row" id="shoppingCart">

                </div>
            </div>
            <div class="d-flex justify-content-end">
                <input type="button" value="移至結帳" class="btn btn-info d-flex justify-self-end goCount" />
            </div>

        </div>

        <template id="template">
            <div class="row mt-3 case">
                <div class="col-1 custom-checkbox "><input type="checkbox" /></div>
                <div class="col-2">
                    <img class="w-100" src="../Assets/Images/img/bar.jpg" alt="Alternate Text" />
                </div>
                <div class="col-3 fontsize">
                    <p class="carttitle"></p>
                    <p class="overflow-hidden txth"></p>
                </div>
                <div class="col-2 fontsize disPrice"></div>
                <div class="col-1">
                    <input type="number" class="number w-100">
                </div>
                <div class="col-2"><p class="tPrice"></p></div>
                <div class="col-1">
                    <i class="fas fa-trash-alt trash"></i>
                </div>
            </div>
        </template>

        @*合併結帳頁*@
        <div class="cartContent p-3">
            <div class="mt-5">
                <h2>付款明細</h2>
            </div>
            <hr>
            <div class="container">
                @*帳單細項*@
                <div class="text-center row">
                    <div class="row col-9" id="payDetail">
                    </div>
                    <div class="col-3 flex-column justify-content-end text-left d-flex">
                        <p id="totalTickets">商品件數:</p>
                        <p id="totalPrice">銷售總金額:</p>
                        <div class="mt-5 text-right">
                            <input class="btn w-50 btn-cust" value="確認結帳" />
                        </div>
                    </div>
                </div>
            </div>
            <hr>
        </div>
    </div>
</div>

<template id="AccountInfo">
    <div class="col-2 ">
        <img class="w-100 rounded" src="../Assets/Images/img/bar.jpg" alt="Alternate Text" />
    </div>
    <div class="w-100 col-10 d-flex flex-wrap bill">
        <p class="w-100 text-left ticketName">日月潭紅茶五吃</p>
        <p class="w-100 text-left text-muted ordate">2020/09/30</p>
        <p class="w-100 text-left text-muted unit border-bottom pb-2"></p>
        <div class="row d-flex flex-wrap w-100 justify-content-end">
            <div class="text-left mr-3"><p>總金額</p></div>
            <div class="w-40 text-left totlPrice"><p>450</p></div>
        </div>
    </div>
</template>
<script src="https://kit.fontawesome.com/bff1bb511a.js" crossorigin="anonymous"></script>

<script>



    var payDetail = document.getElementById("payDetail"); //最一開始的<div .row>空間
    var shoppingCart = document.getElementById("shoppingCart");

    @*var Cart = [
        { id: "dd35a880-1a56-4b5d-ad34-121dcc6c2cc0", amount: 2, title: "ExampleShop Issue5", details: "平假日皆可抵用100元消費金額", price: 556.75 },
        { id: "703d8129-e1b1-4b03-b453-17347be7cfaf", amount: 1, title: "ExampleShop Issue6", details: "平假日皆可抵用100元消費金額", price: 300.75 }];

    var CartString = JSON.stringify(Cart);
    localStorage.setItem("Cart", CartString);*@

    var GetCart = localStorage.getItem("Cart");

    window.onload = function () {

        function AjaxFunction() {
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "../ProductCart/GetIssueData",
                data: GetCart,
                success: function (response) {
                    json = JSON.parse(response);
                    @*console.log(json)*@
                    addIssue(json);

                    var numlist = document.querySelectorAll(".number");
                    for (let i of numlist) {

                        i.addEventListener('change', function (e) {
                            let num = e.target.value
                            let unitPrice = e.target.closest('.row').childNodes[7].innerText;
                            e.target.closest('.row').childNodes[11].innerText = unitPrice * num;
                            if (num < 1) {
                                e.target.value = 1
                            }
                        })

                    }

                    var trashlist = document.querySelectorAll(".trash");
                    console.log(trashlist)
                    for (let i of trashlist) {
                        @*console.dir(i)*@
                        i.addEventListener('click', function (e) {
                            let tickets = e.target.closest('.case');
                            tickets.remove();
                            deleteLocalTrash(`${this.getAttribute("issueid")}`);
                        });
                    }
                },
                error: function () {
                    alert("failed")
                }
            })
        }

    @*function payCount() {
        $.ajax({
            type: "POST",
            contentType: "application/json",
            url: "../ProductCart/GetIssueData",
            data: GetCart,
            success: function (info) {
                infoJson = JSON.parse(info);
                console.log(infoJson);

            }

        })
    }*@




        AjaxFunction();
        @*payCount();*@


        function addIssue(productCartArray) {
            document.getElementById('shoppingCart').innerHTML = "";
            let card = document.querySelector('#template');
        @*console.log(card);*@

            for (let i in productCartArray) {
                let CartContent = card.content.cloneNode(true);    //複製小卡結點

                let tPrice = productCartArray[i].Amount * productCartArray[i].DiscountPrice;
                CartContent.querySelector("img").src = productCartArray[i].ImgPath;
                CartContent.querySelector(".carttitle").innerText = productCartArray[i].Title;
                CartContent.querySelector(".txth").innerText = productCartArray[i].Memo;
                CartContent.querySelector(".disPrice").innerText = productCartArray[i].DiscountPrice;
                CartContent.querySelector(".number").value = productCartArray[i].Amount;
                CartContent.querySelector(".tPrice").innerHTML = tPrice;
                CartContent.querySelector(".trash").setAttribute("issueId", productCartArray[i].Id);


                shoppingCart.append(CartContent);
            }
        };

        function addTicket(productTicketArray) {
            document.getElementById('payDetail').innerHTML = "";
            let countTK = 0;
            let countPrice = 0;
            let tickets = document.querySelector('#AccountInfo');
            for (let tt in productTicketArray) {
                let ttContent = tickets.content.cloneNode(true);    //複製小卡結點

                let time = new Date();
                let timeNow = time.getFullYear() + "-" + [time.getMonth() + 1] + "-" + time.getDate();
                console.log(timeNow)
                ttContent.querySelector("img").src = productTicketArray[tt].img;
                ttContent.querySelector(".ticketName").innerText = productTicketArray[tt].title;
                ttContent.querySelector(".ordate").innerHTML = timeNow;
                ttContent.querySelector(".unit").innerText = "張數: " + productTicketArray[tt].amount;
                ttContent.querySelector(".totlPrice").innerHTML = productTicketArray[tt].total;
                payDetail.append(ttContent);
                countTK += Number(productTicketArray[tt].amount);
                countPrice += Number(productTicketArray[tt].total);
            }
            document.getElementById("totalTickets").innerText = "總購買張數: " + countTK + " 張";
            document.getElementById("totalPrice").innerText = "總購買金額: " + countPrice + " 元";

            console.log(countTK);
            console.log(countPrice);
        };

        function deleteLocalTrash(id) {
            console.log(id);
            console.log("cc");
            let getCartData = JSON.parse(localStorage.getItem('Cart'));
        @*console.log(getCartData);*@
            getCartData = getCartData.filter(x => x.id != id);
            localStorage.setItem("Cart", JSON.stringify(getCartData));
            @*upDateNewLocal();*@
        };

        //function upDateNewLocal() {
        //    window.location.reload();
        //};
     @*setTimeout('upDateNewLocal()', 5000);*@

        function storageNumChange() {
            let caseValue = document.querySelectorAll(".case");
            console.log(caseValue);
            let array = [];
            for (let i of caseValue) {
                let obj = {
                    img: i.children[1].children[0].currentSrc,
                    title: i.children[2].children[0].innerText,
                    amount: i.children[4].children[0].value,
                    total: i.children[5].children[0].innerText
                }
                array.push(obj);
                console.log(array)
            }
            return array
        }

        document.querySelector('.goCount').addEventListener('click', function () {
            let caseValue = document.querySelectorAll(".case");
            console.log(caseValue);
            let array = [];
            for (let i of caseValue) {
                let obj = {
                    img: i.children[1].children[0].currentSrc,
                    title: i.children[2].children[0].innerText,
                    amount: i.children[4].children[0].value,
                    total: i.children[5].innerText
                }
                array.push(obj);
                console.log(array)
            }

            addTicket(array)

        })
    }

</script>

