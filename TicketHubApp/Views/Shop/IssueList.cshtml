@model IEnumerable<TicketHubApp.Models.ViewModels.ShopIssueViewModel>

<div class="container productList">
    <div class="row">
        <div class="col-12 bg-white shadow p-3">
            <div>
                <p>票券列表</p>
            </div>
            <div class="btnList p-2 border-top">
                @Html.ActionLink("票券上架", "CreateIssue", "Shop", null, new { @class = "btn blueBtn" })
                <select class="custom-select blueBtn custom-select-sm w-auto pr-4" id="order">
                    <option selected>編輯排序</option>
                    <option value="1">依銷售數量</option>
                    <option value="2">依上架時間</option>
                    <option value="3">依商品價錢</option>
                </select>
            </div>
            <div class="tableBlock">
                <table class="table table-hover w-100" style=“table-layout:fixed;”>
                    <thead class="position-sticky">
                        <tr>
                            <th></th>
                            <th width="10%">商品圖片</th>
                            <th width="10%">商品名稱</th>
                            <th width="20%">商品編號</th>
                            <th>價格</th>
                            <th>商品狀態</th>
                            <th>上架時間</th>
                            <th>總金額</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="ticketList"></tbody>
                </table>
                <template id="issueTemplate">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="align-middle"><button class="btn redBtn">下架</button></td>
                </template>
            </div>
        </div>
        <div class="col-12 bg-white shadow p-3 mt-5">
            <div>
                <p>歷史票券</p>
            </div>
            <div class="btnList p-2 border-top">
                <select class="custom-select blueBtn custom-select-sm w-auto pr-4" id="orderHistory">
                    <option selected>編輯排序</option>
                    <option value="1">依銷售數量</option>
                    <option value="2">依上架時間</option>
                    <option value="3">依商品價錢</option>
                </select>
            </div>
            <div class="tableBlock">
                <table class="table table-hover">
                    <thead class="position-sticky">
                        <tr>
                            <th></th>
                            <th>商品圖片</th>
                            <th>商品名稱</th>
                            <th>商品編號</th>
                            <th>價格</th>
                            <th>商品狀態</th>
                            <th>上架時間</th>
                            <th>總金額</th>
                        </tr>
                    </thead>
                    <tbody id="historyTicket"></tbody>
                    <template id="historyTemplate">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </template>
                </table>
            </div>
        </div>
    </div>
</div>


@section topCSS{
    <link href="~/Assets/CSS/Shop/productList.min.css" rel="stylesheet" />
}

@section endJS{
    <script>
        var close = true;
        var release = false;

        let selectOrder = document.getElementById("order");
        selectOrder.addEventListener("change", function ordering() {
            fetchData(this.value, "ticketList", release, "issueTemplate");
        });

        let orderHistory = document.getElementById("orderHistory");
        orderHistory.addEventListener("change", function ordering() {
            fetchData(this.value, "historyTicket", close, "historyTemplate");
        });

        fetchData(0, "ticketList", release, "issueTemplate");
        fetchData(0, "historyTicket", close, "historyTemplate");

        async function fetchData(orderValue, parentId, closed, template) {
            $.ajax({
                type: 'POST',
                url: 'getIssueApi',
                data: { order: orderValue, closed: closed },
                success: function (json) {
                    json = JSON.parse(json);
                    genTable(json, parentId, template);
                }
            });
        }

        function genTable(list, parentId, template) {
            let tbody = document.getElementById(parentId);
            tbody.innerHTML = "";
            var templateEle = document.getElementById(template);
            var td = templateEle.content.querySelectorAll("td");
            for (let item of list) {
                let tr = document.createElement("tr");
                if (item.ImgPath) {
                    td[1].innerHTML = `<img src= ${item.ImgPath} />`;
                } else {
                    td[1].innerHTML = "";
                }
                td[1].className += "p-0 align-middle";
                td[2].innerText = item.Title;
                td[3].innerText = item.Id;
                td[4].innerText = item.DiscountPrice;
                td[5].innerText = item.Status;
                td[6].innerHTML = item.ReleasedDate;
                td[7].innerText = item.SalesPrice;
                var clone = document.importNode(templateEle.content, true);
                tr.appendChild(clone);
                tbody.appendChild(tr);
                tr.addEventListener("click", function () {
                    let id = this.children[3].innerText;
                    window.location.assign("IssueDetails" + "?id=" + id);
                });
                if (template == "issueTemplate") {
                    let btn = tr.children[8].children[0];
                    btn.value = item.Id;
                    
                    btn.addEventListener("click", function(e) {
                        closeIssue(this.value)
                        e.stopPropagation();   
                    });
                }
            }
        }  

        function closeIssue(value) {
            $.ajax({
                type: 'POST',
                url: 'closeIssueApi',
                data: { Id: `${value}` },
                success: function (result) {
                    if (result) {
                        alert("下架成功");
                        fetchData(0, "ticketList", release, "issueTemplate");
                        fetchData(0, "historyTicket", close, "historyTemplate");
                    } else {
                        alert("下架失敗");
                    }
                }
            });
        }
    </script>
}